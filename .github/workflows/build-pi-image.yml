name: Build Raspberry Pi Image

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      variant:
        description: 'Image variant (stable/latest)'
        required: true
        default: 'stable'
        type: choice
        options:
          - stable
          - latest
      release_name:
        description: 'Release name (e.g., beta7)'
        required: true
        default: 'beta7'

jobs:
  build-image:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          df -h

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y coreutils quilt parted qemu-user-static \
            debootstrap zerofree zip dosfstools libarchive-tools libcap2-bin \
            grep rsync xz-utils file git curl bc dos2unix arch-test qemu-utils
          # arch-test is checked by pi-gen but not strictly required for arm builds
          # We'll skip the dependency check since QEMU handles cross-compilation

      - name: Clone pi-gen
        run: |
          # Use the bullseye branch - main branch is for Bookworm and has incompatible package names
          git clone --depth 1 --branch bullseye https://github.com/RPi-Distro/pi-gen.git

      - name: Configure pi-gen
        run: |
          cd pi-gen
          
          # Determine variant: from workflow input or default to stable for tag builds
          VARIANT="${{ github.event.inputs.variant }}"
          if [ -z "$VARIANT" ]; then
            VARIANT="stable"
          fi
          
          # Create config - using Bullseye (Legacy 32-bit) for Pi Zero W compatibility
          # Bullseye is lighter than Bookworm but still fully supported
          cat > config <<EOF
          export IMG_NAME=picobrew_picoclaw-${VARIANT}
          export RELEASE=bullseye
          export DEPLOY_ZIP=1
          export LOCALE_DEFAULT=en_US.UTF-8
          export TARGET_HOSTNAME=picoclaw
          export KEYBOARD_KEYMAP=us
          export KEYBOARD_LAYOUT="English (US)"
          export TIMEZONE_DEFAULT=America/New_York
          export FIRST_USER_NAME=pi
          export FIRST_USER_PASS=raspberry
          export ENABLE_SSH=1
          EOF
          
          # Skip desktop stages (lite image only - minimal footprint for Pi Zero W)
          touch ./stage3/SKIP ./stage4/SKIP ./stage5/SKIP
          touch ./stage4/SKIP_IMAGES ./stage5/SKIP_IMAGES
          rm -f stage2/EXPORT_NOOBS || true
          
          # Create custom stage
          mkdir -p stage2/99-picoclaw
          
          # Copy our setup script, updating the variant
          sed "s/export IMG_VARIANT=.*/export IMG_VARIANT=\"${VARIANT}\"/" \
            ../scripts/pi/00-run-chroot.sh > stage2/99-picoclaw/00-run-chroot.sh
          chmod +x stage2/99-picoclaw/00-run-chroot.sh
          
          # Update git clone URL to this repo
          sed -i 's|https://github.com/chiefwigms/picobrew_pico.git|https://github.com/${{ github.repository }}.git|g' \
            stage2/99-picoclaw/00-run-chroot.sh

      - name: Build image
        run: |
          cd pi-gen
          # Skip dependency check (arch-test not available on Ubuntu, but QEMU handles cross-compile)
          sudo SKIP_DEPS_CHECK=1 ./build.sh

      - name: Calculate checksums
        run: |
          cd pi-gen/deploy
          # ensure deploy directory and its contents are writable by the runner
          sudo chmod -R a+rwx . || true
          # make sure the produced .zip files are writable by the runner
          if ls *.zip 1> /dev/null 2>&1; then
            for f in *.zip; do
              md5sum "$f" > "$f.md5"
              sha256sum "$f" > "$f.sha256"
            done
          else
            echo "No .zip files found in pi-gen/deploy"
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: picoclaw-${{ github.event.inputs.variant || 'stable' }}-${{ github.event.inputs.release_name || github.ref_name }}
          path: pi-gen/deploy/*
          retention-days: 30

      - name: Create Release (if tagged)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          prerelease: true
          files: |
            pi-gen/deploy/*.zip
            pi-gen/deploy/*.md5
            pi-gen/deploy/*.sha256
          body: |
            ## ${{ github.ref_name }} - Bullseye Raspberry Pi Images

            ### Purpose

            Setting up a Raspberry Pi server will enable you to continue brewing with your equipment once the Picobrew corporate servers stop functioning. It will enable you to fully operate and control your Pico C/S/Pro or Pico Z/Zymatic.

            If you already have a configured and working Raspberry Pi there is no need to update; doing so will reformat your SD card and lose all files. Back up all related files you want to retain from the Samba/Network Share before updating.

            The server when connected to WiFi should be self-updating when new server source code is released/merged by the maintaining contributors.

            ### Install Procedure

            1. Choose which release variant is appropriate for your setup. If you do not know, choose the **stable** release variant.
            2. Download `picobrew_picoclaw-<variant>-*.zip` and unzip to your desktop/laptop computer.
            3. Insert a Micro SD card into a card reader and the reader into your computer.
            4. Write the extracted `.img` file to the SD card using [Raspberry Pi Imager](https://www.raspberrypi.com/software/).
            5. Eject/remove your SD card from the computer.
            6. (Optional) To configure WiFi access, re-insert the SD card into your computer. Locate the file `wpa_supplicant.conf` in the root directory of the SD card, and modify it with your WiFi network information. Be sure to use quotes around both SSID and password. Then eject/remove the SD from your computer.
            7. Insert the SD into your Pi, power it on, and wait approximately 2-3 minutes.
            8. Move over to your Picobrew machine, and open the network settings. You should see `PICOBREW` as one of the WiFi options. Select it. The password is `PICOBREW`.
            9. Access the web interface at http://picobrew.com or http://192.168.72.1

            ðŸ˜Š **Congratulations, you are now free of the mothership!** ðŸ˜Š

            ### Release Variants

            - **stable**: Uses a known and stable wireless driver (recommended image)
            - **latest**: Uses the most recently released wireless driver (required for Raspberry Pi 400 compatibility)

            ### Checksums

            See `.md5` and `.sha256` files for verification.
